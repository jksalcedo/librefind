name: Release APK

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Create supabase.properties
        run: |
          mkdir -p app/src/main/assets
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > app/src/main/assets/supabase.properties
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> app/src/main/assets/supabase.properties

      - name: Build release APK
        run: |
          ./gradlew assembleRelease \
            --build-cache \
            --parallel \
            --configuration-cache \
            -Dorg.gradle.workers.max=4

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release-keystore.jks

      - name: Sign APK
        run: |
          UNSIGNED_APK=$(find app/build/outputs/apk/release -name '*.apk' | head -1)
          SIGNED_APK="${UNSIGNED_APK%.apk}-signed.apk"

          # Zipalign first
          ${ANDROID_HOME}/build-tools/$(ls ${ANDROID_HOME}/build-tools/ | tail -1)/zipalign -v -p 4 \
            "$UNSIGNED_APK" "${UNSIGNED_APK%.apk}-aligned.apk"

          # Sign with apksigner
          ${ANDROID_HOME}/build-tools/$(ls ${ANDROID_HOME}/build-tools/ | tail -1)/apksigner sign \
            --ks release-keystore.jks \
            --ks-pass pass:${{ secrets.KEYSTORE_PASSWORD }} \
            --ks-key-alias ${{ secrets.KEY_ALIAS }} \
            --key-pass pass:${{ secrets.KEY_PASSWORD }} \
            --out "$SIGNED_APK" \
            "${UNSIGNED_APK%.apk}-aligned.apk"

          echo "path=$SIGNED_APK" >> "$GITHUB_OUTPUT"
          echo "name=$(basename $SIGNED_APK)" >> "$GITHUB_OUTPUT"
        id: sign

      - name: Clean up keystore
        if: always()
        run: rm -f release-keystore.jks

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: " ${{ steps.version.outputs.tag }}"
          generate_release_notes: true
          draft: false
          files: ${{ steps.sign.outputs.path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}